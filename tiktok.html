<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <title>TikTok Downloader - Pro Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        /* Reset & Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: radial-gradient(circle at top left, #1e293b, #0f172a);
            color: #f8fafc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* Container - Glassmorphism */
        .box {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 32px 24px;
            border-radius: 24px;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        h1 {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(to right, #22d3ee, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p.subtitle {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 24px;
        }

        /* Input Group */
        .input-wrap {
            display: flex;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 6px;
            gap: 4px;
            transition: all 0.3s;
            margin-bottom: 16px;
        }

        .input-wrap:focus-within {
            border-color: #38bdf8;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2);
        }

        .input-wrap input {
            flex: 1;
            padding: 12px 14px;
            border: none;
            outline: none;
            background: transparent;
            color: #fff;
            font-size: 15px;
            min-width: 0;
            /* Fix overflow on mobile */
        }

        /* Buttons Styles */
        button {
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        .btn-small {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            flex-shrink: 0;
        }

        .btn-paste {
            background: #334155;
            color: #e2e8f0;
        }

        .btn-paste:hover {
            background: #475569;
        }

        .btn-clear {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
        }

        .btn-clear:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .btn-main {
            width: 100%;
            padding: 14px;
            border-radius: 14px;
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            color: white;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            margin-bottom: 10px;
        }

        .btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
            filter: brightness(1.1);
        }

        .btn-main:active {
            transform: translateY(0);
        }

        /* Results Area */
        #result {
            margin-top: 20px;
            display: grid;
            gap: 10px;
        }

        .download-item {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            background: #f1f5f9;
            color: #0f172a;
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .download-item.video {
            background: #38bdf8;
            color: #fff;
        }

        .download-item.image {
            background: #fff;
            color: #334155;
            border: 1px solid #e2e8f0;
        }

        .download-item:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* UI Helpers */
        .note {
            font-size: 12px;
            color: #64748b;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Loading Spinner Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 480px) {
            .box {
                padding: 24px 16px;
                border-radius: 0;
                height: 100vh;
                max-width: 100%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                border: none;
            }

            body {
                padding: 0;
            }
        }
    </style>
</head>

<body>
    <div class="box">
        <h1>TikTok Downloader</h1>
        <p class="subtitle">T·∫£i Video kh√¥ng logo & ·∫¢nh Slideshow</p>

        <div class="input-wrap">
            <input id="url" type="text" placeholder="D√°n link TikTok t·∫°i ƒë√¢y..." spellcheck="false" />
            <button class="btn-small btn-paste" onclick="pasteUrl()" title="D√°n">üìã</button>
            <button class="btn-small btn-clear" onclick="clearUrl()" title="X√≥a">‚úñ</button>
        </div>

        <button class="btn-main" id="btn-get" onclick="getLink()">B·∫Øt ƒë·∫ßu t·∫£i xu·ªëng</button>

        <div id="result"></div>

        <div class="note">
            üí° <b>PC/Android:</b> T·∫£i tr·ª±c ti·∫øp <br>
            üçé <b>iOS:</b> Video s·∫Ω m·ªü trong tab m·ªõi, nh·∫•n gi·ªØ ƒë·ªÉ L∆∞u.
        </div>
    </div>

    <script>
        function pasteUrl() {
            const input = document.getElementById('url');
            if (!navigator.clipboard) return alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£');
            navigator.clipboard.readText().then(text => {
                if (text) { input.value = text.trim(); input.focus(); }
            }).catch(() => alert('H√£y d√°n th·ªß c√¥ng'));
        }

        function clearUrl() {
            const input = document.getElementById('url');
            input.value = '';
            input.focus();
            document.getElementById('result').innerHTML = '';
        }

        function randomFilename(type) {
            const rand = Math.random().toString(36).slice(2, 10);
            return `tiktok_${Date.now()}_${rand}.${type === 'video' ? 'mp4' : 'jpg'}`;
        }

        async function getLink() {
            const url = document.getElementById('url').value.trim();
            const result = document.getElementById('result');
            const btnGet = document.getElementById('btn-get');

            if (!url || !url.includes('tiktok.com')) {
                result.innerHTML = '<div class="error">‚ùå Vui l√≤ng nh·∫≠p link TikTok h·ª£p l·ªá</div>';
                return;
            }

            btnGet.disabled = true;
            btnGet.innerHTML = '<span class="loading"></span> ƒêang x·ª≠ l√Ω...';
            result.innerHTML = '';

            try {
                const api = `https://www.tikwm.com/api/?url=${encodeURIComponent(url)}`;
                const res = await fetch(api);
                const json = await res.json();

                if (!json || !json.data) {
                    result.innerHTML = '<div class="error">‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu. Link c√≥ th·ªÉ b·ªã ri√™ng t∆∞.</div>';
                } else {
                    const data = json.data;

                    // Video
                    if (data.play) {
                        renderDownloadBtn(data.play, 'video', '‚¨áÔ∏è T·∫£i Video (No Watermark)', 'video');
                    }

                    // Slideshow images
                    if (data.images && data.images.length) {
                        data.images.forEach((img, i) => {
                            renderDownloadBtn(img, 'image', `‚¨áÔ∏è T·∫£i ·∫£nh s·ªë ${i + 1}`, 'image');
                        });
                    }
                }
            } catch (e) {
                result.innerHTML = '<div class="error">‚ùå L·ªói k·∫øt n·ªëi API. Vui l√≤ng th·ª≠ l·∫°i.</div>';
            } finally {
                btnGet.disabled = false;
                btnGet.innerHTML = 'B·∫Øt ƒë·∫ßu t·∫£i xu·ªëng';
            }
        }

        function renderDownloadBtn(url, type, text, className) {
            const result = document.getElementById('result');
            const btn = document.createElement('button');
            btn.className = `download-item ${className}`;
            btn.innerHTML = text;
            btn.onclick = () => downloadFile(url, type, btn);
            result.appendChild(btn);
        }

        async function downloadFile(url, type, btn) {
            const originalText = btn.innerHTML;

            // B∆Ø·ªöC 1: M·ªü ngay m·ªôt tab m·ªõi ƒë·ªÉ "gi·ªØ ch·ªó" (Tr√°nh b·ªã Safari ch·∫∑n)
            // Ch√∫ng ta m·ªü tab tr∆∞·ªõc khi ƒë·ª£i fetch, Safari s·∫Ω coi ƒë√¢y l√† h√†nh ƒë·ªông h·ª£p l·ªá.
            let newTab;
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                newTab = window.open('about:blank', '_blank');
                if (!newTab) {
                    alert('Vui l√≤ng cho ph√©p hi·ªán c·ª≠a s·ªï b·∫≠t l√™n ƒë·ªÉ t·∫£i video');
                    return;
                }
                newTab.document.write('<title>ƒêang x·ª≠ l√Ω...</title><body style="background:#0f172a;color:white;display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;"><div>üöÄ ƒêang chu·∫©n b·ªã t·ªáp tin, vui l√≤ng ch·ªù...</div></body>');
            }

            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> ƒêang x·ª≠ l√Ω...';

                const res = await fetch(url);
                if (!res.ok) throw new Error('Fetch failed');
                const blob = await res.blob();

                // T·∫°o link t·ª´ Blob
                const blobUrl = URL.createObjectURL(blob);

                if (newTab) {
                    // B∆Ø·ªöC 2: ƒê·ªëi v·ªõi iOS - Chuy·ªÉn h∆∞·ªõng tab ƒë√£ m·ªü sang t·ªáp tin
                    // √âp ki·ªÉu octet-stream ƒë·ªÉ hi·ªán th√¥ng b√°o "T·∫£i v·ªÅ"
                    const fileBlob = new Blob([blob], { type: 'application/octet-stream' });
                    const finalUrl = URL.createObjectURL(fileBlob);
                    newTab.location.href = finalUrl;
                } else {
                    // ƒê·ªëi v·ªõi Android/PC - T·∫£i tr·ª±c ti·∫øp nh∆∞ b√¨nh th∆∞·ªùng
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = randomFilename(type);
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }

                setTimeout(() => {
                    btn.innerHTML = '‚úÖ Xong!';
                    btn.disabled = false;
                }, 1000);

            } catch (err) {
                console.error(err);
                const fallbackMsg = 'L·ªói! Nh·∫•p v√†o ƒë·ªÉ m·ªü tr·ª±c ti·∫øp';
                if (newTab) {
                    newTab.location.href = url; // N·∫øu l·ªói fetch, m·ªü link g·ªëc
                } else {
                    window.open(url, '_blank');
                }
                btn.innerHTML = fallbackMsg;
                btn.disabled = false;
            } finally {
                setTimeout(() => btn.innerHTML = originalText, 3000);
            }
        }
    </script>
</body>

</html>
